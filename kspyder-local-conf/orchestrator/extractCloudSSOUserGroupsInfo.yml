Steps:

  - Name: AugmentGroupMembersGroupInfo
    Worker: mongoDBConnector
    Job: execute_query
    Output: CloudSSOGroupMembersFull
    Params:
      query_name: AugmentGroupMembersGroupInfo
      query_conf:
        save: true
        collection: CloudSSOGroupMembers
        operations:
          $lookup:
            from: CloudSSOGroups
            localField: GroupId
            foreignField: GroupId
            as: GroupInfo
          $unwind: $GroupInfo
          $project:
            GroupId: 1
            GroupName: $GroupInfo.GroupName
            UserId: 1
            UserName: 1
            DisplayName: 1
            JoinTime: 1
            Status: 1
            ProvisionType: 1
          $unset:
            - _id
  
  - Name: SaveBackGMembersToMongo
    Worker: mongoDBConnector
    Job: upsert_dataset
    Input: CloudSSOGroupMembersFull
    Output: CloudSSOUsersByGroupFullInsertionResult
    Params:
      collection: CloudSSOGroupMembersFull
      model:
        name: CloudSSOGroupMembersFull
        index_keys:
          - UserId
          - GroupId

  - Name: AugmentGroupMembersUserInfo
    Worker: mongoDBConnector
    Job: execute_query
    Output: CloudSSOGroupMembersFull
    Params:
      query_name: AugmentGroupMembersUserInfo
      query_conf:
        collection: CloudSSOGroupMembersFull
        operations:
          $lookup:
            from: CloudSSOUsers
            localField: UserId
            foreignField: UserId
            as: UserInfo
          $unwind: $UserInfo
          $project:
            GroupId: 1
            GroupName: 1
            UserId: 1
            UserName: 1
            DisplayName: 1
            JoinTime: 1
            Status: 1
            ProvisionType: 1
            Issuer: $UserInfo.ExternalId.Issuer
            IssuerId: $UserInfo.ExternalId.Id
            UserCreatedTime: $UserInfo.CreateTime
            UserUpdatedTime: $UserInfo.UpdateTime
          $unset:
            - _id
  
  - Name: SaveBackGMembersToMongo
    Worker: mongoDBConnector
    Job: upsert_dataset
    Input: CloudSSOGroupMembersFull
    Output: CloudSSOUsersByGroupFullInsertionResult
    Params:
      collection: CloudSSOGroupMembersFull
      model:
        name: CloudSSOGroupMembersFull
        index_keys:
          - UserId
          - GroupId

  - Name: QueryUserInfoWithoutGlobalSyncGroup
    Worker: mongoDBConnector
    Job: execute_query
    Output: CloudSSOGroupMembersLean
    Params:
      query_name: QueryUserInfoWithoutGlobalSyncGroup
      query_conf:
        dump_json: true
        dump_csv: true
        collection: CloudSSOGroupMembersFull
        operations:
          $match:
              GroupName:
                $not:
                  $eq: CDC1DG-ALN-AliyunSync
          $unset:
            - _id

  
