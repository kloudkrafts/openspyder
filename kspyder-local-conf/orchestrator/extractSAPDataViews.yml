Steps:

  # ============= Save and extract raw Instances data for SAP ================

  - Name: View.SAPComputeInstancesData
    Worker: mongoDBConnector
    Job: aggregate_data
    Output: SAPComputeInstances
    DumpJSON: true
    DumpCSV: false
    Params:
      # save_to: SAPComputeInstances
      collection_name: ComputeInstances
      pipeline:
        - $match:
            project:
              $regex: "(s4h)|(sap)|(spc)"
        - $unset:
          - _id

  # - Name: Save.SAPComputeInstancesData
  #   Worker: mongoDBConnector
  #   Job: upsert_dataset
  #   Input: SAPComputeInstances
  #   Output: SAPComputeInstancesInsertionResults
  #   Params:
  #     model:
  #       name: SAPComputeInstances 
  #       index_keys:
  #         - id

  # - Name: Extract.SAPComputeInstancesData
  #   Worker: mongoDBConnector
  #   Job: execute_query
  #   Output: SAPComputeInstancesData
  #   Params:
  #     query_name: Extract.SAPComputeInstancesData
  #     query_conf:
  #       dump_csv: true
  #       dump_json: true
  #       collection: SAPComputeInstances
  #       operations:
  #         $project:
  #           project: 1
  #           id: 1
  #           name: 1
  #           status: 1
  #           created: $creation_timestamp
  #           machine_type:
  #             $arrayElemAt:
  #               - $split:
  #                 - $machine_type
  #                 - "/"
  #               - -1

  # ============= Expand, save, extract Instance NIC data ================

  # - Name: Extend.SAPComputeInstancesData.Nics
  #   Worker: mongoDBConnector
  #   Job: execute_query
  #   Output: SAPComputeExtendedNics
  #   Params:
  #     query_name: Extend.SAPComputeInstancesData.Nics
  #     query_conf:
  #       collection: SAPComputeInstances
  #       operations:
  #         $unwind: $network_interfaces
  #         $unset:
  #           - _id

  # - Name: Save.ExtendedSAPData.Nics
  #   Worker: mongoDBConnector
  #   Job: upsert_dataset
  #   Input: SAPComputeExtendedNics
  #   Output: SAPComputeExtendedNicsInsertionResults
  #   Params:
  #     model:
  #       name: SAPComputeInstances 
  #       index_keys:
  #         - id
  #         - network_interfaces.name

  # - Name: Extend.SAPComputeInstancesData.NicAliases
  #   Worker: mongoDBConnector
  #   Job: execute_query
  #   Output: SAPComputeExtendedNicAliases
  #   Params:
  #     query_name: Extend.SAPComputeInstancesData.NicAliases
  #     query_conf:
  #       collection: SAPComputeNetworkData
  #       dump_json: true
  #       operations:
  #         $unwind: $network_interfaces.alias_ip_ranges
  #         $unset:
  #           - _id

  # - Name: Save.ExtendedSAPData.NicAliases
  #   Worker: mongoDBConnector
  #   Job: upsert_dataset
  #   Input: SAPComputeExtendedNicAliases
  #   Output: SAPComputeExtendedNicsInsertionResults
  #   Params:
  #     model:
  #       name: SAPComputeNetworkData 
  #       index_keys:
  #         - id
  #         - network_interfaces.name
  #         - network_interfaces.alias_ip_ranges


  # - Name: Extract.SAPComputeInstancesData
  #   Worker: mongoDBConnector
  #   Job: execute_query
  #   Output: SAPComputeExtendedNicAliases
  #   Params:
  #     query_name: Extract.SAPComputeInstancesData
  #     query_conf:
  #       dump_csv: true
  #       dump_json: false
  #       collection: SAPComputeInstances
  #       operations:
  #         $project:
  #           project: 1
  #           id: 1
  #           name: 1
  #           status: 1
  #           created: $creation_timestamp
  #           machine_type:
  #             $arrayElemAt:
  #               - $split:
  #                 - $machine_type
  #                 - "/"
  #               - -1
  #           nic: $network_interfaces.name
  #           vpc: 
  #             $arrayElemAt:
  #               - $split:
  #                 - $network_interfaces.network
  #                 - "/"
  #               - -1
  #           subnet: 
  #             $arrayElemAt:
  #               - $split:
  #                 - $network_interfaces.subnetwork
  #                 - "/"
  #               - -1
  #           ip_address: $network_interfaces.network_i_p

  # - Name: Extract.SAPComputeInstancesData.Network
  #   Worker: mongoDBConnector
  #   Job: execute_query
  #   Output: SAPComputeExtendedNicAliases
  #   Params:
  #     query_name: Extract.SAPComputeInstancesData.Network
  #     query_conf:
  #       dump_csv: true
  #       dump_json: false
  #       collection: SAPComputeNetworkData
  #       operations:
  #         $project:
  #           project: 1
  #           id: 1
  #           name: 1
  #           status: 1
  #           created: $creation_timestamp
  #           machine_type:
  #             $arrayElemAt:
  #               - $split:
  #                 - $machine_type
  #                 - "/"
  #               - -1
  #           nic: $network_interfaces.name
  #           vpc: 
  #             $arrayElemAt:
  #               - $split:
  #                 - $network_interfaces.network
  #                 - "/"
  #               - -1
  #           subnet: 
  #             $arrayElemAt:
  #               - $split:
  #                 - $network_interfaces.subnetwork
  #                 - "/"
  #               - -1
  #           ip_address: $network_interfaces.network_i_p
  #           ip_alias: $network_interfaces.alias_ip_ranges.ip_cidr_range

  # # ============= Expand, save, extract Instance Disks data ================

  # - Name: Extend.SAPComputeInstancesData.Disks
  #   Worker: mongoDBConnector
  #   Job: execute_query
  #   Output: SAPComputeExtendedDisks
  #   Params:
  #     query_name: Extend.SAPComputeInstancesData.Disks
  #     query_conf:
  #       collection: SAPComputeInstances
  #       operations:
  #         $unwind: $disks
  #         $unset:
  #           - _id

  # - Name: Save.ExtendedSAPData.Disks
  #   Worker: mongoDBConnector
  #   Job: upsert_dataset
  #   Input: SAPComputeExtendedDisks
  #   Output: SAPComputeExtendedDisksInsertionResults
  #   Params:
  #     model:
  #       name: SAPComputeDiskData 
  #       index_keys:
  #         - id
  #         - disks.device_name

  # - Name: Extract.SAPComputeInstancesData.Disks
  #   Worker: mongoDBConnector
  #   Job: execute_query
  #   Output: SAPComputeInstancesDiskData
  #   Params:
  #     query_name: Extract.SAPComputeInstancesData.Disks
  #     query_conf:
  #       dump_csv: true
  #       dump_json: true
  #       collection: SAPComputeDiskData
  #       operations:
  #         $project:
  #           project: 1
  #           id: 1
  #           name: 1
  #           status: 1
  #           created: $creation_timestamp
  #           machine_type:
  #             $arrayElemAt:
  #               - $split:
  #                 - $machine_type
  #                 - "/"
  #               - -1
  #           disk_name: $disks.device_name
  #           boot_disk: $disks.boot
  #           disk_number: $disks.index
  #           disk_arch: $disks.architecture
  #           disk_size: $disks.disk_size_gb
