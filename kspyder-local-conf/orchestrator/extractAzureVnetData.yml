Steps:

  - Name: GetAzureVnets
    Worker: azureRGraphConnector
    Job: get_data
    Output: AzVnets
    Params:
      model_name: VirtualNetworks

  - Name: StoreAzVnetsToMongo
    Worker : mongoDBConnector
    Job: upsert_dataset
    Input: AzVnets
    Output: AzVnetsInsertionResult
    Params:
      collection: AzureVirtualNetworks

  - Name: ExtractVnetTabularData
    Worker: mongoDBConnector
    Job: execute_query
    Output: VnetDataExtract
    Params:
      query_name: ExtractVnetInfo
      query_conf:
        collection: AzureVirtualNetworks
        dump_csv: true
        dump_json: true
        operations:
          $unwind:
            path: $properties.addressSpace.addressPrefixes
          $project:
            environment: $tags.environment
            name: $name
            region: $location
            subscriptionId: $subscriptionId
            resourceGroup: $resourceGroup
            CIDR: $properties.addressSpace.addressPrefixes
            dnsServers: $properties.dhcpOptions.dnsServers
          $unset:
            - _id

  - Name: ExtractSubnetTabularData
    Worker: mongoDBConnector
    Job: execute_query
    Output: SubnetDataExtract
    Params:
      query_name: ExtractSubnetInfo
      query_conf:
        collection: AzureVirtualNetworks
        dump_csv: true
        dump_json: true
        operations:
          $unwind: $properties.addressSpace.addressPrefixes
          $unwind: $properties.subnets
          $project:
            environment: $tags.environment
            vnetName: $name
            region: $location
            subscriptionId: $subscriptionId
            resourceGroup: $resourceGroup
            vnetCIDR: $properties.addressSpace.addressPrefixes
            vnetDnsServers: $properties.dhcpOptions.dnsServers
            subnetName: $properties.subnets.name
            subnetCIDR: $properties.subnets.properties.addressPrefix
            subnetPurpose: $properties.subnets.purpose
            hasPrivateEndpoints: $properties.subnets.properties.privateEndpointNetworkPolicies
            hasPrivateLinks: $properties.subnets.properties.privateLinkServiceNetworkPolicies
          $unset:
            - _id

